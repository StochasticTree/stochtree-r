<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Running Multiple Chains (Sequentially or in Parallel) in StochTree • stochtree</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Running Multiple Chains (Sequentially or in Parallel) in StochTree">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">stochtree</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>High-Level Model Fitting</h6></li>
    <li><a class="dropdown-item" href="../articles/BayesianSupervisedLearning.html">Bayesian Supervised Learning in StochTree</a></li>
    <li><a class="dropdown-item" href="../articles/CausalInference.html">Causal Machine Learning in StochTree</a></li>
    <li><a class="dropdown-item" href="../articles/Heteroskedasticity.html">Bayesian Supervised Learning with Heteroskedasticity in StochTree</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Advanced Model Interface</h6></li>
    <li><a class="dropdown-item" href="../articles/MultiChain.html">Running Multiple Chains (Sequentially or in Parallel) in StochTree</a></li>
    <li><a class="dropdown-item" href="../articles/ModelSerialization.html">Model Serialization in StochTree</a></li>
    <li><a class="dropdown-item" href="../articles/PriorCalibration.html">Prior Calibration Approaches for Parametric Components of Stochastic Tree Ensembles</a></li>
    <li><a class="dropdown-item" href="../articles/EnsembleKernel.html">Kernel Methods from Tree Ensembles in StochTree</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Prototype Interface</h6></li>
    <li><a class="dropdown-item" href="../articles/CustomSamplingRoutine.html">Custom Sampling Routines in StochTree</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Running Multiple Chains (Sequentially or in Parallel) in StochTree</h1>
            
      

      <div class="d-none name"><code>MultiChain.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>Mixing of an MCMC sampler is a perennial concern for complex Bayesian
models, and BART is no exception. On common way to address such concerns
is to run multiple independent “chains” of an MCMC sampler, so that if
each chain gets stuck in a different region of the posterior, their
combined samples attain better coverage of the full posterior.</p>
<p>This idea works with the classic “from-root” MCMC sampler of <span class="citation">Chipman, George, and McCulloch (2010)</span>, but a key
insight of <span class="citation">He and Hahn (2023)</span> is that the
XBART algorithm may be used to warm-start initialize multiple chains of
the BART MCMC sampler.</p>
<p>Operationally, the above two approaches have the same implementation
(setting <code>num_gfr</code> &gt; 0 if warm-start initialization is
desired), so this vignette will demonstrate how to run a multi-chain
sampler sequentially or in parallel.</p>
<p>To begin, load <code>stochtree</code> and other necessary
packages</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stochastictree.github.io/stochtree-r/">stochtree</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach" class="external-link">foreach</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: iterators</span></span>
<span><span class="co">#&gt; Loading required package: parallel</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="demo-1-supervised-learning">Demo 1: Supervised Learning<a class="anchor" aria-label="anchor" href="#demo-1-supervised-learning"></a>
</h2>
<div class="section level3">
<h3 id="data-simulation">Data Simulation<a class="anchor" aria-label="anchor" href="#data-simulation"></a>
</h3>
<p>Simulate a simple partitioned linear model</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate the data</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">p_x</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">p_w</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">snr</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">p_x</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">p_x</span><span class="op">)</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">*</span><span class="va">p_w</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">p_w</span><span class="op">)</span></span>
<span><span class="va">f_XW</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="op">(</span><span class="fl">0</span> <span class="op">&lt;=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="fl">0.25</span> <span class="op">&gt;</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">-</span><span class="fl">7.5</span><span class="op">*</span><span class="va">W</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="op">(</span><span class="op">(</span><span class="fl">0.25</span> <span class="op">&lt;=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="fl">0.5</span> <span class="op">&gt;</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="op">-</span><span class="fl">2.5</span><span class="op">*</span><span class="va">W</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="op">(</span><span class="op">(</span><span class="fl">0.5</span> <span class="op">&lt;=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="fl">0.75</span> <span class="op">&gt;</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">2.5</span><span class="op">*</span><span class="va">W</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="op">(</span><span class="op">(</span><span class="fl">0.75</span> <span class="op">&lt;=</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="fl">1</span> <span class="op">&gt;</span> <span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">7.5</span><span class="op">*</span><span class="va">W</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">noise_sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">f_XW</span><span class="op">)</span> <span class="op">/</span> <span class="va">snr</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">f_XW</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">noise_sd</span></span>
<span></span>
<span><span class="co"># Split data into test and train sets</span></span>
<span><span class="va">test_set_pct</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">n_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test_set_pct</span><span class="op">*</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">-</span> <span class="va">n_test</span></span>
<span><span class="va">test_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n_test</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train_inds</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">test_inds</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">W_test</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span></span>
<span><span class="va">W_train</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sampling-multiple-chains-sequentially">Sampling Multiple Chains Sequentially<a class="anchor" aria-label="anchor" href="#sampling-multiple-chains-sequentially"></a>
</h3>
<p>Define some high-level parameters, including number of chains to run
and number of samples per chain. Here we run 4 independent chains with 5
warm-start iterations and 100 MCMC iterations each.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_chains</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_trees</span> <span class="op">&lt;-</span> <span class="fl">100</span></span></code></pre></div>
<p>Run the sampler, storing the resulting BART objects in a list</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bart_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bart_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sample_sigma_global <span class="op">=</span> <span class="cn">T</span>, sample_sigma_leaf <span class="op">=</span> <span class="cn">T</span>, num_trees_mean <span class="op">=</span> <span class="va">num_trees</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_chains</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">bart_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">stochtree</span><span class="fu">::</span><span class="fu"><a href="../reference/bart.html">bart</a></span><span class="op">(</span></span>
<span>        X_train <span class="op">=</span> <span class="va">X_train</span>, W_train <span class="op">=</span> <span class="va">W_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, X_test <span class="op">=</span> <span class="va">X_test</span>, </span>
<span>        W_test <span class="op">=</span> <span class="va">W_test</span>, num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>        params <span class="op">=</span> <span class="va">bart_params</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now, if we want to combine the forests from each of these BART models
into a single forest, we can do so as follows</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">json_string_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_chains</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">json_string_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/saveBARTModelToJsonString.html">saveBARTModelToJsonString</a></span><span class="op">(</span><span class="va">bart_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">combined_bart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createBARTModelFromCombinedJsonString.html">createBARTModelFromCombinedJsonString</a></span><span class="op">(</span><span class="va">json_string_list</span><span class="op">)</span></span></code></pre></div>
<p>We can predict from this combined forest as follows</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yhat_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">combined_bart</span>, <span class="va">X_test</span>, <span class="va">W_test</span><span class="op">)</span><span class="op">$</span><span class="va">y_hat</span></span></code></pre></div>
<p>Compare to the original
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>y</mi><mo accent="true">̂</mo></mover><annotation encoding="application/x-tex">\hat{y}</annotation></semantics></math>
values</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_chains</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">offset</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">num_mcmc</span></span>
<span>    <span class="va">inds_start</span> <span class="op">&lt;-</span> <span class="va">offset</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">inds_end</span> <span class="op">&lt;-</span> <span class="va">offset</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bart_models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">y_hat_test</span><span class="op">)</span>, </span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">yhat_combined</span><span class="op">[</span>,<span class="va">inds_start</span><span class="op">:</span><span class="va">inds_end</span><span class="op">]</span><span class="op">)</span>,</span>
<span>         xlab <span class="op">=</span> <span class="st">"original"</span>, ylab <span class="op">=</span> <span class="st">"deserialized"</span>, </span>
<span>         main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Chain "</span>, <span class="va">i</span>, <span class="st">"\nPredictions"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="MultiChain_files/figure-html/unnamed-chunk-7-1.png" width="700"><img src="MultiChain_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="sampling-multiple-chains-in-parallel">Sampling Multiple Chains in Parallel<a class="anchor" aria-label="anchor" href="#sampling-multiple-chains-in-parallel"></a>
</h3>
<p>We use the same high-level parameters as in the sequential demo.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_chains</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_trees</span> <span class="op">&lt;-</span> <span class="fl">100</span></span></code></pre></div>
<p>In order to run this sampler in parallel, a parallel backend must be
registered in your R environment. The code below will register a
parallel backend with access to as many cores are available on your
machine. Note that we do not <strong>evaluate</strong> the code snippet
below in order to interact nicely with CRAN / Github Actions
environments.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ncores</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">ncores</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Note that the <code>bartmodel</code> object contains external
pointers to forests created by the <code>stochtree</code> shared object,
and when <code><a href="../reference/bart.html">stochtree::bart()</a></code> is run in parallel on
independent subprocesses, these pointers are not generally accessible in
the session that kicked off the parallel run.</p>
<p>To overcome this, you can return a JSON representation of a
<code>bartmodel</code> in memory and combine them into a single
in-memory <code>bartmodel</code> object.</p>
<p>The first step of this process is to run the sampler in parallel,
storing the resulting BART JSON strings in a list.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bart_model_outputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">foreach</a></span> <span class="op">(</span>i <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_chains</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/foreach/man/foreach.html" class="external-link">%dopar%</a></span> <span class="op">{</span></span>
<span>  <span class="va">random_seed</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>  <span class="va">bart_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sample_sigma_global <span class="op">=</span> <span class="cn">T</span>, sample_sigma_leaf <span class="op">=</span> <span class="cn">T</span>, </span>
<span>                      num_trees_mean <span class="op">=</span> <span class="va">num_trees</span>, random_seed <span class="op">=</span> <span class="va">random_seed</span><span class="op">)</span></span>
<span>  <span class="va">bart_model</span> <span class="op">&lt;-</span> <span class="fu">stochtree</span><span class="fu">::</span><span class="fu"><a href="../reference/bart.html">bart</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, W_train <span class="op">=</span> <span class="va">W_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, X_test <span class="op">=</span> <span class="va">X_test</span>, W_test <span class="op">=</span> <span class="va">W_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, params <span class="op">=</span> <span class="va">bart_params</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">bart_model_string</span> <span class="op">&lt;-</span> <span class="fu">stochtree</span><span class="fu">::</span><span class="fu"><a href="../reference/saveBARTModelToJsonString.html">saveBARTModelToJsonString</a></span><span class="op">(</span><span class="va">bart_model</span><span class="op">)</span></span>
<span>  <span class="va">y_hat_test</span> <span class="op">&lt;-</span> <span class="va">bart_model</span><span class="op">$</span><span class="va">y_hat_test</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="va">bart_model_string</span>, yhat<span class="op">=</span><span class="va">y_hat_test</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Warning: executing %dopar% sequentially: no parallel backend registered</span></span></code></pre></div>
<p>Close the parallel cluster (not evaluated here, as explained
above).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>Now, if we want to combine the forests from each of these BART models
into a single forest, we can do so as follows</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bart_model_strings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">bart_model_yhats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y_test</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="va">num_chains</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bart_model_outputs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">bart_model_strings</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bart_model_outputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">model</span></span>
<span>    <span class="va">bart_model_yhats</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bart_model_outputs</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">yhat</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">combined_bart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createBARTModelFromCombinedJsonString.html">createBARTModelFromCombinedJsonString</a></span><span class="op">(</span><span class="va">bart_model_strings</span><span class="op">)</span></span></code></pre></div>
<p>We can predict from this combined forest as follows</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yhat_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">combined_bart</span>, <span class="va">X_test</span>, <span class="va">W_test</span><span class="op">)</span><span class="op">$</span><span class="va">y_hat</span></span></code></pre></div>
<p>Compare average predictions from each chain to the original
predictions.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_chains</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">offset</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">num_mcmc</span></span>
<span>    <span class="va">inds_start</span> <span class="op">&lt;-</span> <span class="va">offset</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">inds_end</span> <span class="op">&lt;-</span> <span class="va">offset</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">yhat_combined</span><span class="op">[</span>,<span class="va">inds_start</span><span class="op">:</span><span class="va">inds_end</span><span class="op">]</span><span class="op">)</span>, <span class="va">bart_model_yhats</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>,</span>
<span>         xlab <span class="op">=</span> <span class="st">"deserialized"</span>, ylab <span class="op">=</span> <span class="st">"original"</span>, </span>
<span>         main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Chain "</span>, <span class="va">i</span>, <span class="st">"\nPredictions"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="MultiChain_files/figure-html/unnamed-chunk-14-1.png" width="700"><img src="MultiChain_files/figure-html/unnamed-chunk-14-2.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>And to the true
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>
values.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">num_chains</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">offset</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">i</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="va">num_mcmc</span></span>
<span>    <span class="va">inds_start</span> <span class="op">&lt;-</span> <span class="va">offset</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">inds_end</span> <span class="op">&lt;-</span> <span class="va">offset</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">yhat_combined</span><span class="op">[</span>,<span class="va">inds_start</span><span class="op">:</span><span class="va">inds_end</span><span class="op">]</span><span class="op">)</span>, <span class="va">y_test</span>,</span>
<span>         xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, </span>
<span>         main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Chain "</span>, <span class="va">i</span>, <span class="st">"\nPredictions"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="MultiChain_files/figure-html/unnamed-chunk-15-1.png" width="700"><img src="MultiChain_files/figure-html/unnamed-chunk-15-2.png" width="700"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-chipman2010bart" class="csl-entry">
Chipman, Hugh A., Edward I. George, and Robert E. McCulloch. 2010.
<span>“<span class="nocase">BART: Bayesian additive regression
trees</span>.”</span> <em>The Annals of Applied Statistics</em> 4 (1):
266–98. <a href="https://doi.org/10.1214/09-AOAS285" class="external-link">https://doi.org/10.1214/09-AOAS285</a>.
</div>
<div id="ref-he2023stochastic" class="csl-entry">
He, Jingyu, and P Richard Hahn. 2023. <span>“Stochastic Tree Ensembles
for Regularized Nonlinear Regression.”</span> <em>Journal of the
American Statistical Association</em> 118 (541): 551–70.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Drew Herren, Richard Hahn, Jared Murray, Carlos Carvalho, Jingyu He.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
