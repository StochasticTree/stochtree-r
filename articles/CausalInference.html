<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Causal Machine Learning in StochTree • stochtree</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Causal Machine Learning in StochTree">
<meta property="og:description" content="stochtree">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">stochtree</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BayesianSupervisedLearning.html">Bayesian Supervised Learning in StochTree</a>
    </li>
    <li>
      <a href="../articles/CausalInference.html">Causal Machine Learning in StochTree</a>
    </li>
    <li>
      <a href="../articles/CustomSamplingRoutine.html">Custom Sampling Routines in StochTree</a>
    </li>
    <li>
      <a href="../articles/EnsembleKernel.html">Kernel Methods from Tree Ensembles in StochTree</a>
    </li>
    <li>
      <a href="../articles/ModelSerialization.html">Model Serialization in StochTree</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Causal Machine Learning in StochTree</h1>
            
      
      
      <div class="hidden name"><code>CausalInference.Rmd</code></div>

    </div>

    
    
<p>This vignette demonstrates how to use the <code><a href="../reference/bcf.html">bcf()</a></code> function
for supervised learning. To begin, we load the stochtree package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stochastictree.github.io/stochtree-r/" class="external-link">stochtree</a></span><span class="op">)</span></span></code></pre></div>
<p>We also define several simple functions that configure the data
generating processes used in this vignette.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">==</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span><span class="op">==</span><span class="fl">2</span>,<span class="op">-</span><span class="fl">1</span>,<span class="op">-</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="va">mu1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fl">1</span><span class="op">+</span><span class="fu">g</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">+</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">mu2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fl">1</span><span class="op">+</span><span class="fu">g</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">+</span><span class="fl">6</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="va">tau1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="va">tau2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fl">1</span><span class="op">+</span><span class="fl">2</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">}</span></span></code></pre></div>
<div class="section level2">
<h2 id="binary-treatment">Binary Treatment<a class="anchor" aria-label="anchor" href="#binary-treatment"></a>
</h2>
<div class="section level3">
<h3 id="demo-1-nonlinear-outcome-model-heterogeneous-treatment-effect">Demo 1: Nonlinear Outcome Model, Heterogeneous Treatment Effect<a class="anchor" aria-label="anchor" href="#demo-1-nonlinear-outcome-model-heterogeneous-treatment-effect"></a>
</h3>
<p>We consider the following data generating process from <span class="citation">Hahn, Murray, and Carvalho (2020)</span>:</p>
<p><span class="math display">\[\begin{equation*}
\begin{aligned}
y &amp;= \mu(X) + \tau(X) Z + \epsilon\\
\epsilon &amp;\sim N\left(0,\sigma^2\right)\\
\mu(X) &amp;= 1 + g(X) + 6 \lvert X_3 - 1 \rvert\\
\tau(X) &amp;= 1 + 2 X_2 X_4\\
g(X) &amp;= \mathbb{I}(X_5=1) \times 2 - \mathbb{I}(X_5=2) \times 1 -
\mathbb{I}(X_5=3) \times 4\\
s_{\mu} &amp;= \sqrt{\mathbb{V}(\mu(X))}\\
\pi(X) &amp;= 0.8 \phi\left(\frac{3\mu(X)}{s_{\mu}}\right) -
\frac{X_1}{2} + \frac{2U+1}{20}\\
X_1,X_2,X_3 &amp;\sim N\left(0,1\right)\\
X_4 &amp;\sim \text{Bernoulli}(1/2)\\
X_5 &amp;\sim \text{Categorical}(1/3,1/3,1/3)\\
U &amp;\sim \text{Uniform}\left(0,1\right)\\
Z &amp;\sim \text{Bernoulli}\left(\pi(X)\right)
\end{aligned}
\end{equation*}\]</span></p>
<div class="section level4">
<h4 id="simulation">Simulation<a class="anchor" aria-label="anchor" href="#simulation"></a>
</h4>
<p>We draw from the DGP defined above</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">snr</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="va">n</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x1</span>,<span class="va">x2</span>,<span class="va">x3</span>,<span class="va">x4</span>,<span class="va">x5</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">mu_x</span> <span class="op">&lt;-</span> <span class="fu">mu1</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">tau_x</span> <span class="op">&lt;-</span> <span class="fu">tau2</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">pi_x</span> <span class="op">&lt;-</span> <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="va">mu_x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">mu_x</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.05</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="va">pi_x</span><span class="op">)</span></span>
<span><span class="va">E_XZ</span> <span class="op">&lt;-</span> <span class="va">mu_x</span> <span class="op">+</span> <span class="va">Z</span><span class="op">*</span><span class="va">tau_x</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">E_XZ</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">E_XZ</span><span class="op">)</span><span class="op">/</span><span class="va">snr</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x4</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x5</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split data into test and train sets</span></span>
<span><span class="va">test_set_pct</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">n_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test_set_pct</span><span class="op">*</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">-</span> <span class="va">n_test</span></span>
<span><span class="va">test_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n_test</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train_inds</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">test_inds</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X_test</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span></span>
<span><span class="va">pi_test</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">pi_train</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">Z_test</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">Z_train</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">mu_test</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">mu_train</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">tau_test</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">tau_train</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="sampling-and-analysis">Sampling and Analysis<a class="anchor" aria-label="anchor" href="#sampling-and-analysis"></a>
</h4>
<div class="section level5">
<h5 id="warmstart">Warmstart<a class="anchor" aria-label="anchor" href="#warmstart"></a>
</h5>
<p>We first simulate from an ensemble model of <span class="math inline">\(y \mid X\)</span> using “warm-start”
initialization samples (<span class="citation">Krantsevich, He, and Hahn
(2023)</span>). This is the default in <code>stochtree</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_warmstart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples that were initialized with an XBART
warm-start</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot-2.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.98</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="bart-mcmc-without-warmstart">BART MCMC without Warmstart<a class="anchor" aria-label="anchor" href="#bart-mcmc-without-warmstart"></a>
</h5>
<p>Next, we simulate from this ensemble model without any warm-start
initialization.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_root</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples after burnin</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot-2.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.96</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="demo-2-linear-outcome-model-heterogeneous-treatment-effect">Demo 2: Linear Outcome Model, Heterogeneous Treatment Effect<a class="anchor" aria-label="anchor" href="#demo-2-linear-outcome-model-heterogeneous-treatment-effect"></a>
</h3>
<p>We consider the following data generating process from <span class="citation">Hahn, Murray, and Carvalho (2020)</span>:</p>
<p><span class="math display">\[\begin{equation*}
\begin{aligned}
y &amp;= \mu(X) + \tau(X) Z + \epsilon\\
\epsilon &amp;\sim N\left(0,\sigma^2\right)\\
\mu(X) &amp;= 1 + g(X) + 6 X_1 X_3\\
\tau(X) &amp;= 1 + 2 X_2 X_4\\
g(X) &amp;= \mathbb{I}(X_5=1) \times 2 - \mathbb{I}(X_5=2) \times 1 -
\mathbb{I}(X_5=3) \times 4\\
s_{\mu} &amp;= \sqrt{\mathbb{V}(\mu(X))}\\
\pi(X) &amp;= 0.8 \phi\left(\frac{3\mu(X)}{s_{\mu}}\right) -
\frac{X_1}{2} + \frac{2U+1}{20}\\
X_1,X_2,X_3 &amp;\sim N\left(0,1\right)\\
X_4 &amp;\sim \text{Bernoulli}(1/2)\\
X_5 &amp;\sim \text{Categorical}(1/3,1/3,1/3)\\
U &amp;\sim \text{Uniform}\left(0,1\right)\\
Z &amp;\sim \text{Bernoulli}\left(\pi(X)\right)
\end{aligned}
\end{equation*}\]</span></p>
<div class="section level4">
<h4 id="simulation-1">Simulation<a class="anchor" aria-label="anchor" href="#simulation-1"></a>
</h4>
<p>We draw from the DGP defined above</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">snr</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="va">n</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x1</span>,<span class="va">x2</span>,<span class="va">x3</span>,<span class="va">x4</span>,<span class="va">x5</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">mu_x</span> <span class="op">&lt;-</span> <span class="fu">mu2</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">tau_x</span> <span class="op">&lt;-</span> <span class="fu">tau2</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">pi_x</span> <span class="op">&lt;-</span> <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="va">mu_x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">mu_x</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.05</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="va">pi_x</span><span class="op">)</span></span>
<span><span class="va">E_XZ</span> <span class="op">&lt;-</span> <span class="va">mu_x</span> <span class="op">+</span> <span class="va">Z</span><span class="op">*</span><span class="va">tau_x</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">E_XZ</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">E_XZ</span><span class="op">)</span><span class="op">/</span><span class="va">snr</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x4</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x5</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split data into test and train sets</span></span>
<span><span class="va">test_set_pct</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">n_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test_set_pct</span><span class="op">*</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">-</span> <span class="va">n_test</span></span>
<span><span class="va">test_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n_test</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train_inds</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">test_inds</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X_test</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span></span>
<span><span class="va">pi_test</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">pi_train</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">Z_test</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">Z_train</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">mu_test</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">mu_train</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">tau_test</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">tau_train</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="sampling-and-analysis-1">Sampling and Analysis<a class="anchor" aria-label="anchor" href="#sampling-and-analysis-1"></a>
</h4>
<div class="section level5">
<h5 id="warmstart-1">Warmstart<a class="anchor" aria-label="anchor" href="#warmstart-1"></a>
</h5>
<p>We first simulate from an ensemble model of <span class="math inline">\(y \mid X\)</span> using “warm-start”
initialization samples (<span class="citation">Krantsevich, He, and Hahn
(2023)</span>). This is the default in <code>stochtree</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_warmstart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples that were initialized with an XBART
warm-start</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_2-1.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_2-2.png" width="700"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_2-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.89</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="bart-mcmc-without-warmstart-1">BART MCMC without Warmstart<a class="anchor" aria-label="anchor" href="#bart-mcmc-without-warmstart-1"></a>
</h5>
<p>Next, we simulate from this ensemble model without any warm-start
initialization.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_root</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples after burnin</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot_2-1.png" width="700"></p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot_2-2.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot_2-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.82</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="demo-3-linear-outcome-model-homogeneous-treatment-effect">Demo 3: Linear Outcome Model, Homogeneous Treatment Effect<a class="anchor" aria-label="anchor" href="#demo-3-linear-outcome-model-homogeneous-treatment-effect"></a>
</h3>
<p>We consider the following data generating process from <span class="citation">Hahn, Murray, and Carvalho (2020)</span>:</p>
<p><span class="math display">\[\begin{equation*}
\begin{aligned}
y &amp;= \mu(X) + \tau(X) Z + \epsilon\\
\epsilon &amp;\sim N\left(0,\sigma^2\right)\\
\mu(X) &amp;= 1 + g(X) + 6 X_1 X_3\\
\tau(X) &amp;= 3\\
g(X) &amp;= \mathbb{I}(X_5=1) \times 2 - \mathbb{I}(X_5=2) \times 1 -
\mathbb{I}(X_5=3) \times 4\\
s_{\mu} &amp;= \sqrt{\mathbb{V}(\mu(X))}\\
\pi(X) &amp;= 0.8 \phi\left(\frac{3\mu(X)}{s_{\mu}}\right) -
\frac{X_1}{2} + \frac{2U+1}{20}\\
X_1,X_2,X_3 &amp;\sim N\left(0,1\right)\\
X_4 &amp;\sim \text{Bernoulli}(1/2)\\
X_5 &amp;\sim \text{Categorical}(1/3,1/3,1/3)\\
U &amp;\sim \text{Uniform}\left(0,1\right)\\
Z &amp;\sim \text{Bernoulli}\left(\pi(X)\right)
\end{aligned}
\end{equation*}\]</span></p>
<div class="section level4">
<h4 id="simulation-2">Simulation<a class="anchor" aria-label="anchor" href="#simulation-2"></a>
</h4>
<p>We draw from the DGP defined above</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">snr</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="va">n</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x1</span>,<span class="va">x2</span>,<span class="va">x3</span>,<span class="va">x4</span>,<span class="va">x5</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">mu_x</span> <span class="op">&lt;-</span> <span class="fu">mu2</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">tau_x</span> <span class="op">&lt;-</span> <span class="fu">tau1</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">pi_x</span> <span class="op">&lt;-</span> <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="va">mu_x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">mu_x</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.05</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="va">pi_x</span><span class="op">)</span></span>
<span><span class="va">E_XZ</span> <span class="op">&lt;-</span> <span class="va">mu_x</span> <span class="op">+</span> <span class="va">Z</span><span class="op">*</span><span class="va">tau_x</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">E_XZ</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">E_XZ</span><span class="op">)</span><span class="op">/</span><span class="va">snr</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x4</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x5</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split data into test and train sets</span></span>
<span><span class="va">test_set_pct</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">n_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test_set_pct</span><span class="op">*</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">-</span> <span class="va">n_test</span></span>
<span><span class="va">test_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n_test</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train_inds</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">test_inds</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X_test</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span></span>
<span><span class="va">pi_test</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">pi_train</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">Z_test</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">Z_train</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">mu_test</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">mu_train</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">tau_test</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">tau_train</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="sampling-and-analysis-2">Sampling and Analysis<a class="anchor" aria-label="anchor" href="#sampling-and-analysis-2"></a>
</h4>
<div class="section level5">
<h5 id="warmstart-2">Warmstart<a class="anchor" aria-label="anchor" href="#warmstart-2"></a>
</h5>
<p>We first simulate from an ensemble model of <span class="math inline">\(y \mid X\)</span> using “warm-start”
initialization samples (<span class="citation">Krantsevich, He, and Hahn
(2023)</span>). This is the default in <code>stochtree</code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_warmstart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples that were initialized with an XBART
warm-start</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_3-1.png" width="700"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_3-2.png" width="700"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_3-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="bart-mcmc-without-warmstart-2">BART MCMC without Warmstart<a class="anchor" aria-label="anchor" href="#bart-mcmc-without-warmstart-2"></a>
</h5>
<p>Next, we simulate from this ensemble model without any warm-start
initialization.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_root</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples after burnin</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot_3-1.png" width="700"></p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot_3-2.png" width="700"></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot_3-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="demo-4-nonlinear-outcome-model-heterogeneous-treatment-effect">Demo 4: Nonlinear Outcome Model, Heterogeneous Treatment Effect<a class="anchor" aria-label="anchor" href="#demo-4-nonlinear-outcome-model-heterogeneous-treatment-effect"></a>
</h3>
<p>We consider the following data generating process:</p>
<p><span class="math display">\[\begin{equation*}
\begin{aligned}
y &amp;= \mu(X) + \tau(X) Z + \epsilon\\
\epsilon &amp;\sim N\left(0,\sigma^2\right)\\
\mu(X) &amp;= \begin{cases}
-1.1 &amp; \text{ if} X_1 &gt; X_2\\
0.9 &amp; \text{ if} X_1 \leq X_2
\end{cases}\\
\tau(X) &amp;= \frac{1}{1+\exp(-X_3)} + \frac{X_2}{10}\\
\pi(X) &amp;= \Phi\left(\mu(X)\right)\\
Z &amp;\sim \text{Bernoulli}\left(\pi(X)\right)\\
X_1,X_2,X_3 &amp;\sim N\left(0,1\right)\\
X_4 &amp;\sim N\left(X_2,1\right)\\
\end{aligned}
\end{equation*}\]</span></p>
<div class="section level4">
<h4 id="simulation-3">Simulation<a class="anchor" aria-label="anchor" href="#simulation-3"></a>
</h4>
<p>We draw from the DGP defined above</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>,<span class="va">x2</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x1</span>,<span class="va">x2</span>,<span class="va">x3</span>,<span class="va">x4</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">&gt;</span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">*</span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">&lt;</span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.1</span><span class="op">}</span></span>
<span><span class="va">tau</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">/</span><span class="fl">10</span><span class="op">}</span></span>
<span><span class="va">mu_x</span> <span class="op">&lt;-</span> <span class="fu">mu</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">tau_x</span> <span class="op">&lt;-</span> <span class="fu">tau</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">pi_x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">mu_x</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="va">pi_x</span><span class="op">)</span></span>
<span><span class="va">E_XZ</span> <span class="op">&lt;-</span> <span class="va">mu_x</span> <span class="op">+</span> <span class="va">Z</span><span class="op">*</span><span class="va">tau_x</span></span>
<span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">mu_x</span> <span class="op">+</span> <span class="va">tau_x</span><span class="op">*</span><span class="va">pi</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">8</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">E_XZ</span> <span class="op">+</span> <span class="va">sigma</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split data into test and train sets</span></span>
<span><span class="va">test_set_pct</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">n_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test_set_pct</span><span class="op">*</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">-</span> <span class="va">n_test</span></span>
<span><span class="va">test_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n_test</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train_inds</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">test_inds</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X_test</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span></span>
<span><span class="va">pi_test</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">pi_train</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">Z_test</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">Z_train</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">mu_test</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">mu_train</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">tau_test</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">tau_train</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="sampling-and-analysis-3">Sampling and Analysis<a class="anchor" aria-label="anchor" href="#sampling-and-analysis-3"></a>
</h4>
<div class="section level5">
<h5 id="warmstart-3">Warmstart<a class="anchor" aria-label="anchor" href="#warmstart-3"></a>
</h5>
<p>We first simulate from an ensemble model of <span class="math inline">\(y \mid X\)</span> using “warm-start”
initialization samples (<span class="citation">Krantsevich, He, and Hahn
(2023)</span>). This is the default in <code>stochtree</code>.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_warmstart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples that were initialized with an XBART
warm-start</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_4-1.png" width="700"></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_4-2.png" width="700"></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_4-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.99</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="bart-mcmc-without-warmstart-3">BART MCMC without Warmstart<a class="anchor" aria-label="anchor" href="#bart-mcmc-without-warmstart-3"></a>
</h5>
<p>Next, we simulate from this ensemble model without any warm-start
initialization.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_root</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples after burnin</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot_4-1.png" width="700"></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot_4-2.png" width="700"></p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_root_plot_4-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.98</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="demo-5-nonlinear-outcome-model-heterogeneous-treatment-effect-with-additive-random-effects">Demo 5: Nonlinear Outcome Model, Heterogeneous Treatment Effect with
Additive Random Effects<a class="anchor" aria-label="anchor" href="#demo-5-nonlinear-outcome-model-heterogeneous-treatment-effect-with-additive-random-effects"></a>
</h3>
<p>We augment the simulated example in Demo 1 with an additive random
effect structure and show that the <code><a href="../reference/bcf.html">bcf()</a></code> function can
estimate and incorporate these effects into its forest sampling
procedure.</p>
<div class="section level4">
<h4 id="simulation-4">Simulation<a class="anchor" aria-label="anchor" href="#simulation-4"></a>
</h4>
<p>We draw from the augmented “demo 1” DGP</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">snr</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="va">n</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x1</span>,<span class="va">x2</span>,<span class="va">x3</span>,<span class="va">x4</span>,<span class="va">x5</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">mu_x</span> <span class="op">&lt;-</span> <span class="fu">mu1</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">tau_x</span> <span class="op">&lt;-</span> <span class="fu">tau2</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">pi_x</span> <span class="op">&lt;-</span> <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="va">mu_x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">mu_x</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.05</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="va">pi_x</span><span class="op">)</span></span>
<span><span class="va">E_XZ</span> <span class="op">&lt;-</span> <span class="va">mu_x</span> <span class="op">+</span> <span class="va">Z</span><span class="op">*</span><span class="va">tau_x</span></span>
<span><span class="va">group_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, <span class="va">n</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">rfx_coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, nrow<span class="op">=</span><span class="fl">2</span>, byrow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">rfx_basis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span>, <span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rfx_term</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">rfx_coefs</span><span class="op">[</span><span class="va">group_ids</span>,<span class="op">]</span> <span class="op">*</span> <span class="va">rfx_basis</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">E_XZ</span> <span class="op">+</span> <span class="va">rfx_term</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">E_XZ</span><span class="op">)</span><span class="op">/</span><span class="va">snr</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x4</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x5</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split data into test and train sets</span></span>
<span><span class="va">test_set_pct</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">n_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test_set_pct</span><span class="op">*</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">-</span> <span class="va">n_test</span></span>
<span><span class="va">test_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n_test</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train_inds</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">test_inds</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X_test</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span></span>
<span><span class="va">pi_test</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">pi_train</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">Z_test</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">Z_train</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">mu_test</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">mu_train</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">tau_test</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">tau_train</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">group_ids_test</span> <span class="op">&lt;-</span> <span class="va">group_ids</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">group_ids_train</span> <span class="op">&lt;-</span> <span class="va">group_ids</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">rfx_basis_test</span> <span class="op">&lt;-</span> <span class="va">rfx_basis</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span></span>
<span><span class="va">rfx_basis_train</span> <span class="op">&lt;-</span> <span class="va">rfx_basis</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span></span>
<span><span class="va">rfx_term_test</span> <span class="op">&lt;-</span> <span class="va">rfx_term</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">rfx_term_train</span> <span class="op">&lt;-</span> <span class="va">rfx_term</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="sampling-and-analysis-4">Sampling and Analysis<a class="anchor" aria-label="anchor" href="#sampling-and-analysis-4"></a>
</h4>
<div class="section level5">
<h5 id="warmstart-4">Warmstart<a class="anchor" aria-label="anchor" href="#warmstart-4"></a>
</h5>
<p>Here we simulate only from the “warm-start” model (running root-MCMC
BART with random effects is simply a matter of modifying the below code
snippet by setting <code>num_gfr &lt;- 0</code> and
<code>num_mcmc</code> &gt; 0).</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_warmstart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    group_ids_train <span class="op">=</span> <span class="va">group_ids_train</span>, rfx_basis_train <span class="op">=</span> <span class="va">rfx_basis_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, group_ids_test <span class="op">=</span> <span class="va">group_ids_test</span>,</span>
<span>    rfx_basis_test <span class="op">=</span> <span class="va">rfx_basis_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">T</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples that were initialized with an XBART
warm-start</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_rfx-1.png" width="700"></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_rfx-2.png" width="700"></p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">y_hat_test</span><span class="op">)</span>, <span class="va">y_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Outcome"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_rfx-3.png" width="700"></p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">rfx_preds_test</span><span class="op">)</span>, <span class="va">rfx_term_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Random effects terms"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_rfx-4.png" width="700"></p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">-</span><span class="va">rfx_term</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/bart_warmstart_plot_rfx-5.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.94</span></span></code></pre></div>
<p>It is clear that causal inference is much more difficult in the
presence of <strong>both</strong> strong covariate-dependent prognostic
effects and strong group-level random effects. In this sense, proper
prior calibration for all three of the <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\tau\)</span> and random effects models is
crucial.</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="demo-6-nonlinear-outcome-model-heterogeneous-treatment-effect-using-different-features-in-the-prognostic-and-treatment-forests">Demo 6: Nonlinear Outcome Model, Heterogeneous Treatment Effect
using Different Features in the Prognostic and Treatment Forests<a class="anchor" aria-label="anchor" href="#demo-6-nonlinear-outcome-model-heterogeneous-treatment-effect-using-different-features-in-the-prognostic-and-treatment-forests"></a>
</h3>
<p>Here, we consider the case in which we might prefer to use only a
subset of covariates in the treatment effect forest. Why might we want
to do that? Well, in many cases it is plausible that some covariates
(for example age, income, etc…) influence the outcome of interest in a
causal problem, but do not <strong>moderate</strong> the treatment
effect. In this case, we’d need to include these variables in the
prognostic forest for deconfounding but we don’t necessarily need to
include them in the treatment effect forest.</p>
<div class="section level4">
<h4 id="simulation-5">Simulation<a class="anchor" aria-label="anchor" href="#simulation-5"></a>
</h4>
<p>We draw from a modified “demo 1” DGP</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fl">1</span><span class="op">+</span><span class="fu">g</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">+</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">-</span><span class="va">x</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">+</span><span class="fl">3</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">}</span></span>
<span><span class="va">tau</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fl">1</span><span class="op">+</span><span class="fl">0.5</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">-</span><span class="fl">0.25</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">x</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">snr</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,<span class="va">n</span>,replace<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x1</span>,<span class="va">x2</span>,<span class="va">x3</span>,<span class="va">x4</span>,<span class="va">x5</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">mu_x</span> <span class="op">&lt;-</span> <span class="fu">mu</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">tau_x</span> <span class="op">&lt;-</span> <span class="fu">tau</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">pi_x</span> <span class="op">&lt;-</span> <span class="fl">0.8</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="op">(</span><span class="fl">3</span><span class="op">*</span><span class="va">mu_x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">mu_x</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.05</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">/</span><span class="fl">10</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">1</span>,<span class="va">pi_x</span><span class="op">)</span></span>
<span><span class="va">E_XZ</span> <span class="op">&lt;-</span> <span class="va">mu_x</span> <span class="op">+</span> <span class="va">Z</span><span class="op">*</span><span class="va">tau_x</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">E_XZ</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">E_XZ</span><span class="op">)</span><span class="op">/</span><span class="va">snr</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x4</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">X</span><span class="op">$</span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">X</span><span class="op">$</span><span class="va">x5</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split data into test and train sets</span></span>
<span><span class="va">test_set_pct</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">n_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test_set_pct</span><span class="op">*</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">-</span> <span class="va">n_test</span></span>
<span><span class="va">test_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n_test</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train_inds</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">test_inds</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X_test</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span></span>
<span><span class="va">pi_test</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">pi_train</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">Z_test</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">Z_train</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">mu_test</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">mu_train</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">tau_test</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">tau_train</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="sampling-and-analysis-5">Sampling and Analysis<a class="anchor" aria-label="anchor" href="#sampling-and-analysis-5"></a>
</h4>
<div class="section level5">
<h5 id="mcmc-full-covariate-set-in-taux">MCMC, full covariate set in <span class="math inline">\(\tau(X)\)</span><a class="anchor" aria-label="anchor" href="#mcmc-full-covariate-set-in-taux"></a>
</h5>
<p>Here we simulate from the model with the original MCMC sampler, using
all of the covariates in both the prognostic (<span class="math inline">\(\mu(X)\)</span>) and treatment effect (<span class="math inline">\(\tau(X)\)</span>) forests.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the burned-in samples</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-23-2.png" width="700"></p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-23-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>And test set RMSE</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">test_mean</span> <span class="op">-</span> <span class="va">tau_test</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3537478</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="mcmc-covariate-subset-in-taux">MCMC, covariate subset in <span class="math inline">\(\tau(X)\)</span><a class="anchor" aria-label="anchor" href="#mcmc-covariate-subset-in-taux"></a>
</h5>
<p>Here we simulate from the model with the original MCMC sampler, using
only covariate <span class="math inline">\(X_1\)</span> in the treatment
effect forest.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span>, </span>
<span>    keep_vars_tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-27-2.png" width="700"></p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-27-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>And test set RMSE</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_mcmc</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">test_mean</span> <span class="op">-</span> <span class="va">tau_test</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3634036</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="warmstart-full-covariate-set-in-taux">Warmstart, full covariate set in <span class="math inline">\(\tau(X)\)</span><a class="anchor" aria-label="anchor" href="#warmstart-full-covariate-set-in-taux"></a>
</h5>
<p>Here we simulate from the model with the warm-start sampler, using
all of the covariates in both the prognostic (<span class="math inline">\(\mu(X)\)</span>) and treatment effect (<span class="math inline">\(\tau(X)\)</span>) forests.</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_warmstart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples that were initialized with an XBART
warm-start</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-31-2.png" width="700"></p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-31-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>And test set RMSE</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span> <span class="op">-</span> <span class="va">test_mean</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3707581</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="warmstart-covariate-subset-in-taux">Warmstart, covariate subset in <span class="math inline">\(\tau(X)\)</span><a class="anchor" aria-label="anchor" href="#warmstart-covariate-subset-in-taux"></a>
</h5>
<p>Here we simulate from the model with the warm-start sampler, using
only covariate <span class="math inline">\(X_1\)</span> in the treatment
effect forest.</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_warmstart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span>, </span>
<span>    keep_vars_tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples that were initialized with an XBART
warm-start</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-35-1.png" width="700"></p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-35-2.png" width="700"></p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-35-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
<p>And test set RMSE</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span> <span class="op">-</span> <span class="va">test_mean</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.3568036</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="continuous-treatment">Continuous Treatment<a class="anchor" aria-label="anchor" href="#continuous-treatment"></a>
</h2>
<div class="section level3">
<h3 id="demo-1-nonlinear-outcome-model-heterogeneous-treatment-effect-1">Demo 1: Nonlinear Outcome Model, Heterogeneous Treatment Effect<a class="anchor" aria-label="anchor" href="#demo-1-nonlinear-outcome-model-heterogeneous-treatment-effect-1"></a>
</h3>
<p>We consider the following data generating process:</p>
<p><span class="math display">\[\begin{equation*}
\begin{aligned}
y &amp;= \mu(X) + \tau(X) Z + \epsilon\\
\epsilon &amp;\sim N\left(0,\sigma^2\right)\\
\mu(X) &amp;= 1 + 2 X_1 - \mathbb{1}\left(X_2 &lt; 0\right) \times 4 +
\mathbb{1}\left(X_2 \geq 0\right) \times 4 + 3 \left(\lvert X_3 \rvert -
\sqrt{\frac{2}{\pi}} \right)\\
\tau(X) &amp;= 1 + 2 X_4\\
X_1,X_2,X_3,X_4,X_5 &amp;\sim N\left(0,1\right)\\
U &amp;\sim \text{Uniform}\left(0,1\right)\\
\pi(X) &amp;= \frac{\mu(X) - 1}{2} + 4 \left(U - \frac{1}{2}\right)\\
Z &amp;\sim \mathcal{N}\left(\pi(X), 1\right)
\end{aligned}
\end{equation*}\]</span></p>
<div class="section level4">
<h4 id="simulation-6">Simulation<a class="anchor" aria-label="anchor" href="#simulation-6"></a>
</h4>
<p>We draw from the DGP defined above</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">snr</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">x5</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">x1</span>,<span class="va">x2</span>,<span class="va">x3</span>,<span class="va">x4</span>,<span class="va">x5</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">mu_x</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">x1</span> <span class="op">-</span> <span class="fl">4</span><span class="op">*</span><span class="op">(</span><span class="va">x2</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fl">4</span><span class="op">*</span><span class="op">(</span><span class="va">x2</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">x3</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">/</span><span class="va">pi</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tau_x</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">x4</span></span>
<span><span class="va">u</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">pi_x</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="va">mu_x</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">/</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span> <span class="fl">4</span><span class="op">*</span><span class="op">(</span><span class="va">u</span><span class="op">-</span><span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">Z</span> <span class="op">&lt;-</span> <span class="va">pi_x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">E_XZ</span> <span class="op">&lt;-</span> <span class="va">mu_x</span> <span class="op">+</span> <span class="va">Z</span><span class="op">*</span><span class="va">tau_x</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">E_XZ</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">*</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">E_XZ</span><span class="op">)</span><span class="op">/</span><span class="va">snr</span><span class="op">)</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split data into test and train sets</span></span>
<span><span class="va">test_set_pct</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span><span class="va">n_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">test_set_pct</span><span class="op">*</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="va">n</span> <span class="op">-</span> <span class="va">n_test</span></span>
<span><span class="va">test_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">n_test</span>, replace <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">train_inds</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">test_inds</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">X_test</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">test_inds</span>,<span class="op">]</span></span>
<span><span class="va">X_train</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">train_inds</span>,<span class="op">]</span></span>
<span><span class="va">pi_test</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">pi_train</span> <span class="op">&lt;-</span> <span class="va">pi_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">Z_test</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">Z_train</span> <span class="op">&lt;-</span> <span class="va">Z</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">y_test</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">y_train</span> <span class="op">&lt;-</span> <span class="va">y</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">mu_test</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">mu_train</span> <span class="op">&lt;-</span> <span class="va">mu_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span>
<span><span class="va">tau_test</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span></span>
<span><span class="va">tau_train</span> <span class="op">&lt;-</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">train_inds</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="sampling-and-analysis-6">Sampling and Analysis<a class="anchor" aria-label="anchor" href="#sampling-and-analysis-6"></a>
</h4>
<div class="section level5">
<h5 id="warmstart-5">Warmstart<a class="anchor" aria-label="anchor" href="#warmstart-5"></a>
</h5>
<p>We first simulate from an ensemble model of <span class="math inline">\(y \mid X\)</span> using “warm-start”
initialization samples (<span class="citation">Krantsevich, He, and Hahn
(2023)</span>). This is the default in <code>stochtree</code>.</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_warmstart</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples that were initialized with an XBART
warm-start</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-40-1.png" width="700"></p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-40-2.png" width="700"></p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-40-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_warmstart</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.89</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="bart-mcmc-without-warmstart-4">BART MCMC without Warmstart<a class="anchor" aria-label="anchor" href="#bart-mcmc-without-warmstart-4"></a>
</h5>
<p>Next, we simulate from this ensemble model without any warm-start
initialization.</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_gfr</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">num_burnin</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_mcmc</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">num_samples</span> <span class="op">&lt;-</span> <span class="va">num_gfr</span> <span class="op">+</span> <span class="va">num_burnin</span> <span class="op">+</span> <span class="va">num_mcmc</span></span>
<span><span class="va">bcf_model_root</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bcf.html">bcf</a></span><span class="op">(</span></span>
<span>    X_train <span class="op">=</span> <span class="va">X_train</span>, Z_train <span class="op">=</span> <span class="va">Z_train</span>, y_train <span class="op">=</span> <span class="va">y_train</span>, pi_train <span class="op">=</span> <span class="va">pi_train</span>, </span>
<span>    X_test <span class="op">=</span> <span class="va">X_test</span>, Z_test <span class="op">=</span> <span class="va">Z_test</span>, pi_test <span class="op">=</span> <span class="va">pi_test</span>, </span>
<span>    num_gfr <span class="op">=</span> <span class="va">num_gfr</span>, num_burnin <span class="op">=</span> <span class="va">num_burnin</span>, num_mcmc <span class="op">=</span> <span class="va">num_mcmc</span>, </span>
<span>    sample_sigma_leaf_mu <span class="op">=</span> <span class="cn">F</span>, sample_sigma_leaf_tau <span class="op">=</span> <span class="cn">F</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Inspect the BART samples after burnin</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">mu_hat_test</span><span class="op">)</span>, <span class="va">mu_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Prognostic function"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-43-1.png" width="700"></p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span><span class="op">)</span>, <span class="va">tau_test</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"predicted"</span>, ylab <span class="op">=</span> <span class="st">"actual"</span>, main <span class="op">=</span> <span class="st">"Treatment effect"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">"red"</span>,lty<span class="op">=</span><span class="fl">3</span>,lwd<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-43-2.png" width="700"></p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma_observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">y</span><span class="op">-</span><span class="va">E_XZ</span><span class="op">)</span></span>
<span><span class="va">plot_bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                 <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, <span class="va">sigma_observed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">sigma2_samples</span>, ylim <span class="op">=</span> <span class="va">plot_bounds</span>, </span>
<span>     ylab <span class="op">=</span> <span class="st">"sigma^2"</span>, xlab <span class="op">=</span> <span class="st">"Sample"</span>, main <span class="op">=</span> <span class="st">"Global variance parameter"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="va">sigma_observed</span>, lty<span class="op">=</span><span class="fl">3</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CausalInference_files/figure-html/unnamed-chunk-43-3.png" width="700"></p>
<p>Examine test set interval coverage</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.025</span><span class="op">)</span></span>
<span><span class="va">test_ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bcf_model_root</span><span class="op">$</span><span class="va">tau_hat_test</span>, <span class="fl">1</span>, <span class="va">quantile</span>, <span class="fl">0.975</span><span class="op">)</span></span>
<span><span class="va">cover</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="op">(</span><span class="va">test_lb</span> <span class="op">&lt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>    <span class="op">(</span><span class="va">test_ub</span> <span class="op">&gt;=</span> <span class="va">tau_x</span><span class="op">[</span><span class="va">test_inds</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cover</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.85</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-hahn2020bayesian" class="csl-entry">
Hahn, P Richard, Jared S Murray, and Carlos M Carvalho. 2020.
<span>“Bayesian Regression Tree Models for Causal Inference:
Regularization, Confounding, and Heterogeneous Effects (with
Discussion).”</span> <em>Bayesian Analysis</em> 15 (3): 965–1056.
</div>
<div id="ref-krantsevich2023stochastic" class="csl-entry">
Krantsevich, Nikolay, Jingyu He, and P Richard Hahn. 2023.
<span>“Stochastic Tree Ensembles for Estimating Heterogeneous
Effects.”</span> In <em>International Conference on Artificial
Intelligence and Statistics</em>, 6120–31. PMLR.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Drew Herren, Richard Hahn, Jared Murray, Carlos Carvalho, Jingyu He.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
